
define(['aloha','jquery','aloha/plugin','ui/ui','ui/scopes','ui/button','ui/toggleButton','i18n!list/nls/i18n','i18n!aloha/nls/i18n','aloha/engine','PubSub'],function(Aloha,jQuery,Plugin,Ui,Scopes,Button,ToggleButton,i18n,i18nCore,Engine,PubSub){'use strict';var GENTICS=window.GENTICS;function transformExistingListAndSubLists(domToTransform,transformTo){jQuery(domToTransform).find(domToTransform.nodeName).each(function(){if(isListInSelection(this)){Aloha.Markup.transformDomObject(this,transformTo,Aloha.Selection.rangeObject);}});Aloha.Markup.transformDomObject(domToTransform,transformTo,Aloha.Selection.rangeObject);}
function isListInSelection(needle){var selectionTree=Aloha.Selection.getSelectionTree();return checkSelectionTreeEntryForElement(selectionTree,needle);}
function checkSelectionTreeEntryForElement(treeElementArray,needle){var found=false;jQuery.each(treeElementArray,function(index,element){if((element.domobj===needle&&element.selection!=="none")||checkSelectionTreeEntryForElement(element.children,needle)){found=true;}});return found;}
var ListPlugin=Plugin.create('list',{config:['ul','ol'],transformableElements:{'p':true,'h1':true,'h2':true,'h3':true,'h4':true,'h5':true,'h6':true,'ul':true,'ol':true},init:function(){var that=this;this._orderedListButton=Ui.adopt("orderedList",ToggleButton,{tooltip:i18n.t("button.createolist.tooltip"),icon:"aloha-icon aloha-icon-orderedlist",scope:'Aloha.continuoustext',click:function(){that.transformList(true);}});this._unorderedListButton=Ui.adopt("unorderedList",ToggleButton,{tooltip:i18n.t("button.createulist.tooltip"),icon:"aloha-icon aloha-icon-unorderedlist",scope:'Aloha.continuoustext',click:function(){that.transformList(false);}});this._indentListButton=Ui.adopt("indentList",Button,{tooltip:i18n.t('button.indentlist.tooltip'),icon:'aloha-icon aloha-icon-indent',scope:'Aloha.continuoustext',click:function(){that.indentList();}});this._outdentListButton=Ui.adopt("outdentList",Button,{tooltip:i18n.t('button.outdentlist.tooltip'),icon:'aloha-icon aloha-icon-outdent',scope:'Aloha.continuoustext',click:function(){that.outdentList();}});Scopes.createScope('Aloha.List','Aloha.continuoustext');PubSub.sub('aloha.selection.context-change',function(message){var i,effectiveMarkup,rangeObject=message.range;that._outdentListButton.show(false);that._indentListButton.show(false);that._unorderedListButton.setState(false);that._orderedListButton.setState(false);for(i=0;i<rangeObject.markupEffectiveAtStart.length;i++){effectiveMarkup=rangeObject.markupEffectiveAtStart[i];if(Aloha.Selection.standardTagNameComparator(effectiveMarkup,jQuery('<ul></ul>'))){that._unorderedListButton.setState(true);that._outdentListButton.show(true);that._indentListButton.show(true);break;}
if(Aloha.Selection.standardTagNameComparator(effectiveMarkup,jQuery('<ol></ol>'))){that._orderedListButton.setState(true);that._outdentListButton.show(true);that._indentListButton.show(true);break;}}
if(Aloha.activeEditable){that.applyButtonConfig(Aloha.activeEditable.obj);}});Aloha.Markup.addKeyHandler(9,function(event){return that.processTab(event);});},applyButtonConfig:function(obj){var config=this.getEditableConfig(obj);if(Aloha.Selection.rangeObject.unmodifiableMarkupAtStart[0]){if(jQuery.inArray('ul',config)!=-1&&Aloha.Selection.canTag1WrapTag2(Aloha.Selection.rangeObject.unmodifiableMarkupAtStart[0].nodeName,"ul")!=-1){this._unorderedListButton.show(true);}else{this._unorderedListButton.show(false);}
if(jQuery.inArray('ol',config)!=-1&&Aloha.Selection.canTag1WrapTag2(Aloha.Selection.rangeObject.unmodifiableMarkupAtStart[0].nodeName,"ol")!=-1){this._orderedListButton.show(true);}else{this._orderedListButton.show(false);}}},processTab:function(event){if(event.keyCode===9){if(event.shiftKey){return this.outdentList();}else{return this.indentList();}}
return true;},getStartingDomObjectToTransform:function(){var rangeObject=Aloha.Selection.rangeObject,i,effectiveMarkup;for(i=0;i<rangeObject.markupEffectiveAtStart.length;i++){effectiveMarkup=rangeObject.markupEffectiveAtStart[i];if(this.transformableElements[effectiveMarkup.nodeName.toLowerCase()]){return effectiveMarkup;}}
return false;},getNearestSelectedListItem:function(){var rangeObject=Aloha.Selection.rangeObject,i,effectiveMarkup;for(i=0;i<rangeObject.markupEffectiveAtStart.length;i++){effectiveMarkup=rangeObject.markupEffectiveAtStart[i];if(GENTICS.Utils.Dom.isListElement(effectiveMarkup)){return effectiveMarkup;}}
return false;},transformList:function(ordered){var domToTransform=this.getStartingDomObjectToTransform(),lastLi,i,jqNewLi,jqList,selectedSiblings,jqParentList,newPara,jqToTransform,nodeName;this._outdentListButton.show(true);this._indentListButton.show(true);if(!domToTransform){Aloha.Selection.changeMarkupOnSelection(jQuery('<p></p>'));domToTransform=this.getStartingDomObjectToTransform();if(!domToTransform){if(Aloha.Selection.rangeObject.startContainer.contentEditable){jqList=ordered?jQuery('<ol></ol>'):jQuery('<ul></ul>');jqNewLi=jQuery('<li></li>');jqList.append(jqNewLi);var li=jqNewLi.get(0);var editable=Aloha.getActiveEditable().obj;li.appendChild(document.createTextNode(""));editable.append(jqList);editable.focus();var range=Aloha.createRange();var selection=Aloha.getSelection();range.setStart(li.firstChild,0);range.setEnd(li.firstChild,0);selection.removeAllRanges();selection.addRange(range);Aloha.Selection.updateSelection();return;}else{Aloha.Log.error(this,'Could not transform selection into a list');return;}}}
nodeName=domToTransform.nodeName.toLowerCase();if(nodeName=='ul'&&!ordered){jqList=jQuery(domToTransform);jqParentList=jqList.parent();if(jqParentList.length>0&&GENTICS.Utils.Dom.isListElement(jqParentList.get(0))){if(jqParentList.get(0).nodeName.toLowerCase()==='li'){jqParentList.after(jqList.children());jqList.remove();}else{jqList.children().unwrap();}}else{jqToTransform=jQuery(domToTransform);jQuery.each(jqToTransform.children('li'),function(index,li){newPara=Aloha.Markup.transformDomObject(li,'p',Aloha.Selection.rangeObject);newPara.after(newPara.children('ol,ul'));Engine.ensureContainerEditable(newPara.get(0));});jqToTransform.children().unwrap();}}else if(nodeName=='ul'&&ordered){transformExistingListAndSubLists(domToTransform,'ol');this.mergeAdjacentLists(jQuery(domToTransform));}else if(nodeName=='ol'&&!ordered){transformExistingListAndSubLists(domToTransform,'ul');this.mergeAdjacentLists(jQuery(domToTransform));}else if(nodeName=='ol'&&ordered){jqList=jQuery(domToTransform);jqParentList=jqList.parent();if(jqParentList.length>0&&GENTICS.Utils.Dom.isListElement(jqParentList.get(0))){if(jqParentList.get(0).nodeName.toLowerCase()==='li'){jqParentList.after(jqList.children());jqList.remove();}else{jqList.children().unwrap();}}else{jqToTransform=jQuery(domToTransform);jQuery.each(jqToTransform.children('li'),function(index,li){newPara=Aloha.Markup.transformDomObject(li,'p',Aloha.Selection.rangeObject);newPara.after(newPara.children('ol,ul'));Engine.ensureContainerEditable(newPara.get(0));});jqToTransform.children().unwrap();}}else{selectedSiblings=Aloha.Selection.rangeObject.getSelectedSiblings(domToTransform);jqList=ordered?jQuery('<ol></ol>'):jQuery('<ul></ul>');jqNewLi=jQuery('<li></li>');jqList.append(jqNewLi);jQuery(domToTransform).contents().appendTo(jqNewLi);jQuery(domToTransform).replaceWith(jqList);if(Aloha.Selection.rangeObject.startContainer==domToTransform){Aloha.Selection.rangeObject.startContainer=jqNewLi.get(0);}
if(Aloha.Selection.rangeObject.endContainer==domToTransform){Aloha.Selection.rangeObject.endContainer=jqNewLi.get(0);}
var lastAppendedLi=jqNewLi;if(selectedSiblings){lastLi=false;for(i=0;i<selectedSiblings.length;++i){if(GENTICS.Utils.Dom.isBlockLevelElement(selectedSiblings[i])){if(lastLi){lastLi=false;}
jqNewLi=Aloha.Markup.transformDomObject(selectedSiblings[i],'li',Aloha.Selection.rangeObject);jqList.append(jqNewLi);lastAppendedLi=jqNewLi;}else{if(selectedSiblings[i].nodeType==3&&jQuery.trim(selectedSiblings[i].data).length===0){continue;}
if(!lastLi){lastLi=jQuery('<li></li>');jqList.append(lastLi);lastAppendedLi=lastLi;}
lastLi.append(selectedSiblings[i]);}}}
this.mergeAdjacentLists(jqList);var li=lastAppendedLi.get(0);if(GENTICS.Utils.Dom.isEmpty(li)){var range=Aloha.createRange();var selection=Aloha.getSelection();li.appendChild(document.createTextNode(""));range.selectNodeContents(li.lastChild);selection.removeAllRanges();selection.addRange(range);Aloha.Selection.updateSelection();}}
this.refreshSelection();},indentList:function(){var listItem=this.getNearestSelectedListItem(),i,jqNewList,selectedSiblings,jqOldList,jqItemBefore;if(listItem){jqItemBefore=jQuery(listItem).prev('li');if(jqItemBefore.length===0){return false;}
jqOldList=jQuery(listItem).parent();selectedSiblings=Aloha.Selection.rangeObject.getSelectedSiblings(listItem);jqNewList=jQuery(listItem).parent().clone(false).empty();jqNewList.append(listItem);jqItemBefore.append(jqNewList);if(selectedSiblings){for(i=0;i<selectedSiblings.length;++i){jqNewList.append(jQuery(selectedSiblings[i]));}}
this.mergeAdjacentLists(jqNewList,true);this.refreshSelection();return false;}
return true;},outdentList:function(){var
listItem=this.getNearestSelectedListItem(),i,jqNewPostList,jqListItem,jqList,jqParentList,wrappingLi,selectedSiblings,lastSelected;if(listItem){jqListItem=jQuery(listItem);jqList=jqListItem.parent();jqParentList=jqList.parents('ul,ol');wrappingLi=jqList.parent('li');if(jqParentList.length>0&&GENTICS.Utils.Dom.isListElement(jqParentList.get(0))){selectedSiblings=Aloha.Selection.rangeObject.getSelectedSiblings(listItem);if(selectedSiblings&&selectedSiblings.length>0){lastSelected=jQuery(selectedSiblings[selectedSiblings.length-1]);}else{lastSelected=jqListItem;}
if(lastSelected.nextAll('li').length>0){jqNewPostList=jqList.clone(false).empty();jqNewPostList.append(lastSelected.nextAll());lastSelected.append(jqNewPostList);}
if(wrappingLi.length>0){wrappingLi.after(jqListItem);}else{jqList.before(jqListItem);}
if(selectedSiblings&&selectedSiblings.length>0){for(i=selectedSiblings.length-1;i>=0;--i){jqListItem.after(jQuery(selectedSiblings[i]));}}
if(jqList.contents('li').length===0){jqList.remove();}
if(wrappingLi.length>0&&wrappingLi.contents().length===0){wrappingLi.remove();}
this.refreshSelection();}
return false;}
return true;},refreshSelection:function(){Aloha.Selection.rangeObject.update();Aloha.Selection.rangeObject.select();Aloha.Selection.updateSelection();},mergeAdjacentLists:function(jqList,allTypes){var firstList=jqList.get(0),jqNextList;while(firstList.previousSibling&&firstList.previousSibling.nodeType===1&&this.isMergable(firstList.previousSibling,firstList,allTypes)){firstList=firstList.previousSibling;}
jqList=jQuery(firstList);while(firstList.nextSibling&&((firstList.nextSibling.nodeType===1&&this.isMergable(firstList.nextSibling,firstList,allTypes))||(firstList.nextSibling.nodeType===3&&jQuery.trim(firstList.nextSibling.data).length===0))){jqNextList=jQuery(firstList.nextSibling);if(firstList.nextSibling.nodeType==1){jqNextList.contents().appendTo(jqList);}
jqNextList.remove();}},isMergable:function(toCheck,mergeInto,allTypes){if(allTypes){return toCheck.nodeName.toLowerCase()=='ul'||toCheck.nodeName.toLowerCase()=='ol';}else{return toCheck.nodeName==mergeInto.nodeName;}}});Engine.commands['insertorderedlist']={action:function(value,range){ListPlugin.transformList(true);if(range&&Aloha.Selection.rangeObject){range.startContainer=Aloha.Selection.rangeObject.startContainer;range.startOffset=Aloha.Selection.rangeObject.startOffset;range.endContainer=Aloha.Selection.rangeObject.endContainer;range.endOffset=Aloha.Selection.rangeObject.endOffset;}},indeterm:function(){},state:function(){for(i=0;i<rangeObject.markupEffectiveAtStart.length;i++){effectiveMarkup=rangeObject.markupEffectiveAtStart[i];if(Aloha.Selection.standardTagNameComparator(effectiveMarkup,jQuery('<ul></ul>'))){return false;}
if(Aloha.Selection.standardTagNameComparator(effectiveMarkup,jQuery('<ol></ol>'))){return true;}}
return false;}};Engine.commands['insertunorderedlist']={action:function(value,range){ListPlugin.transformList(false);if(range&&Aloha.Selection.rangeObject){range.startContainer=Aloha.Selection.rangeObject.startContainer;range.startOffset=Aloha.Selection.rangeObject.startOffset;range.endContainer=Aloha.Selection.rangeObject.endContainer;range.endOffset=Aloha.Selection.rangeObject.endOffset;}},indeterm:function(){},state:function(){for(i=0;i<rangeObject.markupEffectiveAtStart.length;i++){effectiveMarkup=rangeObject.markupEffectiveAtStart[i];if(Aloha.Selection.standardTagNameComparator(effectiveMarkup,jQuery('<ul></ul>'))){return true;}
if(Aloha.Selection.standardTagNameComparator(effectiveMarkup,jQuery('<ol></ol>'))){return false;}}
return false;}};Engine.commands['indent']={action:function(value,range){ListPlugin.indentList();if(range&&Aloha.Selection.rangeObject){range.startContainer=Aloha.Selection.rangeObject.startContainer;range.startOffset=Aloha.Selection.rangeObject.startOffset;range.endContainer=Aloha.Selection.rangeObject.endContainer;range.endOffset=Aloha.Selection.rangeObject.endOffset;}},indeterm:function(){},state:function(){return false;}};Engine.commands['outdent']={action:function(value,range){ListPlugin.outdentList();if(range&&Aloha.Selection.rangeObject){range.startContainer=Aloha.Selection.rangeObject.startContainer;range.startOffset=Aloha.Selection.rangeObject.startOffset;range.endContainer=Aloha.Selection.rangeObject.endContainer;range.endOffset=Aloha.Selection.rangeObject.endOffset;}},indeterm:function(){},state:function(){return false;}};function deleteWorkaroundHandler(event){if(8!=event.keyCode&&46!=event.keyCode){return false;}
var rangeObj=Aloha.getSelection().getRangeAt(0);var startContainer=rangeObj.startContainer;var $nestedList=jQuery(startContainer).closest('ul, ol');if(!$nestedList.length){return false;}
var $parentList=$nestedList.parent().closest('ul, ol');if(!$parentList.length){return false;}
var ranges=Aloha.getSelection().getAllRanges();var actionPerformed=false;$parentList.each(function(){actionPerformed=actionPerformed||fixListNesting(jQuery(this));});if(actionPerformed){Aloha.getSelection().setRanges(ranges);for(var i=0;i<ranges.length;i++){ranges[i].detach();}}
return actionPerformed;}
function fixListNesting($list){var actionPerformed=false;$list.children('ul, ol').each(function(){Aloha.Log.debug("performing list-nesting cleanup");if(!jQuery(this).prev('li').append(this).length){jQuery(this).parent().prepend(document.createElement('li')).append(this);}
actionPerformed=true;});return actionPerformed;}
return ListPlugin;});