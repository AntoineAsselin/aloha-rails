
define(['aloha','jquery','ui/scopes','ui/dialog','i18n!table/nls/i18n','table/table-cell','table/table-selection','table/table-plugin-utils'],function(Aloha,jQuery,Scopes,Dialog,i18n,TableCell,TableSelection,Utils){var undefined=void 0;var GENTICS=window.GENTICS;var Table=function(table,tablePlugin){this.obj=jQuery(table);correctTableStructure(this);if(!this.obj.attr('id')){this.obj.attr('id',GENTICS.Utils.guid());}
this.tablePlugin=tablePlugin;this.selection=new TableSelection(this);this.refresh();};jQuery.extend(Table.prototype,{obj:undefined,tableWrapper:undefined,cells:undefined,numRows:undefined,numCols:undefined,isActive:false,hasFocus:false,parentEditable:undefined,mousedown:false,clickedColumnId:-1,clickedRowId:-1,columnsToSelect:[],rowsToSelect:[],fmPluginId:undefined});Table.prototype.refresh=function(){this.numCols=this.countVirtualCols();var rows=this.getRows();this.numRows=rows.length;this.cells=[];for(var i=0;i<rows.length;i++){var row=jQuery(rows[i]);var cols=row.children();for(var j=0;j<cols.length;j++){var col=cols[j];var Cell=this.newCell(col);}}};Table.prototype.countVirtualCols=function(){var $firstRow=this.obj.children().children('tr:first-child').children();return $firstRow.length-$firstRow.filter('.'+this.get('classLeftUpperCorner')).length;};Table.prototype.get=function(property){return this.tablePlugin.get(property);};Table.prototype.set=function(key,value){this.tablePlugin.set(key,value);};function correctTableStructure(tableObj){var table=tableObj.obj,i,j,row,rows=tableObj.getRows(),rowsNum=rows.length,cols,colsNum,colsCount,maxColsCount=0,cachedColsCounts=[rowsNum],colsCountDiff,colSpan;for(i=0;i<rowsNum;i++){row=jQuery(rows[i]);cols=row.children('td, th');colsNum=cols.length;colsCount=Utils.cellIndexToGridColumn(rows,i,colsNum-1)+1;colSpan=parseInt(cols.last().attr('colspan'),10);if(colSpan==0){}else if(!isNaN(colSpan)){if(colSpan==1){cols.last().removeAttr('colspan');}
colsCount+=(colSpan-1);}
rowSpan=parseInt(cols.last().attr('rowspan'),10);if(rowSpan>1){for(j=1;j<rowSpan-1;j++){if(colSpan>1){cachedColsCounts[i+j]+=colSpan;}else{cachedColsCounts[i+j]+=1;}}}
cachedColsCounts[i]+=colsCount;if(cachedColsCounts[i]>maxColsCount){maxColsCount=cachedColsCounts[i];}}
for(i=0;i<rowsNum;i++){colsCountDiff=maxColsCount-cachedColsCounts[i];if(colsCountDiff>0){jQuery(rows[i]).append((new Array(colsCountDiff+1)).join('<td></td>'));}}};function setActiveStyle(selectedCells,config,items,button){var className;var allSelected=false;for(var i=0;i<items.length;i++){button.showItem(items[i].name);}
button.setActiveItem();for(var i=0;i<config.length;i++){if(jQuery(selectedCells[0]).hasClass(config[i].cssClass)){allSelected=true;className=config[i].name;break;}}
jQuery(selectedCells).each(function(index){if(!jQuery(this).hasClass(className)){allSelected=false;}});if(allSelected){button.setActiveItem(className);}}
Table.prototype.activate=function(){if(this.isActive){return;}
var that=this,htmlTableWrapper,tableWrapper,eventContainer;this.obj.addClass(this.get('className'));this.obj.contentEditable(false);if(this.obj.attr('id')==''){this.obj.attr('id',GENTICS.Utils.guid());}
this.selection.selectionType=undefined;eventContainer=this.obj.children('tbody');if(eventContainer.length===0){eventContainer=this.obj;}
eventContainer.bind('keydown',function(jqEvent){if(!jqEvent.ctrlKey&&!jqEvent.shiftKey){if(that.selection.selectedCells.length>0&&that.selection.selectedCells[0].length>0){that.selection.selectedCells[0][0].firstChild.focus();}}});eventContainer.delegate('td','mousemove',function(e){var jqObj=jQuery(this);var mouseOffset=3;if(jQuery(this).hasClass('aloha-table-selectrow')||jQuery(this).closest('tr').hasClass('aloha-table-selectcolumn'))
return;var closeToLeftBorder=function(cell){return((e.pageX-cell.offset().left)<mouseOffset);};var closeToTopBorder=function(cell){return((e.pageY-cell.offset().top)<mouseOffset);};var closeToTableBottom=function(cell){var row=cell.closest('tr');if(row.next('tr').length>0){return false}
var cursorOffset=e.pageY-(row.offset().top+row.outerHeight());return cursorOffset>(mouseOffset* -1)&&cursorOffset<mouseOffset;}
var colResize=that.tablePlugin.colResize;var rowResize=that.tablePlugin.rowResize;if(colResize&&closeToLeftBorder(jqObj)){jqObj.css('cursor','col-resize');return that.attachColumnResize(jqObj);}else if(rowResize&&closeToTopBorder(jqObj)){jqObj.css('cursor','row-resize');return that.attachRowResize(jqObj);}else if(rowResize&&closeToTableBottom(jqObj)){jqObj.css('cursor','row-resize');return that.attachRowResize(jqObj,true);}else{jqObj.css('cursor','default');return that.detachRowColResize(jqObj);}});eventContainer.bind('mousemove',function(e){var jqObj=jQuery(this).closest('table');var isTableRightBorder=function(table){var cursorOffset=e.pageX-(table.offset().left+table.outerWidth());return cursorOffset>-5&&cursorOffset<5;};var tableResize=that.tablePlugin.tableResize;if(tableResize&&isTableRightBorder(jqObj)){return that.attachTableResizeWidth(jqObj);}});eventContainer.bind('mousedown',function(jqEvent){if(!that.hasFocus){that.focus();}
jqEvent.stopPropagation();jqEvent.preventDefault();return false;});tableWrapper=jQuery('<div class="'+this.get('classTableWrapper')+'" data-block-skip-scope="true"></div>');this.obj.wrap(tableWrapper);var parent=this.obj.parent();if(parent.alohaBlock){parent.alohaBlock();}
htmlTableWrapper=this.obj.parents('.'+this.get('classTableWrapper'));htmlTableWrapper.get(0).onresizestart=function(e){return false;};htmlTableWrapper.get(0).oncontrolselect=function(e){return false;};htmlTableWrapper.get(0).ondragstart=function(e){return false;};htmlTableWrapper.get(0).onmovestart=function(e){return false;};this.tableWrapper=this.obj.parents('.'+this.get('classTableWrapper')).get(0);jQuery(this.cells).each(function(){this.activate();});this.attachSelectionColumn();this.attachSelectionRow();this.makeCaptionEditable();this.checkWai();this.isActive=true;Aloha.trigger('aloha-table-activated');};Table.prototype.makeCaptionEditable=function(){var caption=this.obj.find('caption').eq(0);if(caption){this.tablePlugin.makeCaptionEditable(caption);}};Table.prototype.checkWai=function(){var w=this.wai;if(!w){return;}
w.removeClass(this.get('waiGreen'));w.removeClass(this.get('waiRed'));if(jQuery.trim(this.obj[0].summary)!=''){w.addClass(this.get('waiGreen'));}else{w.addClass(this.get('waiRed'));}};Table.prototype.attachSelectionColumn=function(){var emptyCell=jQuery('<td>'),rowIndex,columnToInsert,rowObj,that=this,rows,i;emptyCell.html('\u00a0');that=this;rows=this.obj.context.rows;for(i=0;i<rows.length;i++){rowObj=jQuery(rows[i]);columnToInsert=emptyCell.clone();columnToInsert.addClass(this.get('classSelectionColumn'));columnToInsert.css('width',this.get('selectionArea')+'px');rowObj.prepend(columnToInsert);rowIndex=i+1;this.attachRowSelectionEventsToCell(columnToInsert);}};Table.prototype.attachRowSelectionEventsToCell=function(cell){var that=this;cell.unbind('mousedown');cell.unbind('mouseover');cell.get(0).onselectstart=function(){return false;};cell.bind('mousedown',function(e){return that.rowSelectionMouseDown(e);});cell.bind('mouseover',function(e){if(that.mousedown){return that.rowSelectionMouseOver(e);}});};Table.prototype.rowSelectionMouseDown=function(jqEvent){this.focus();if(this.selection.selectedCells.length==0){this.rowsToSelect=[];}
this.clickedRowId=jqEvent.currentTarget.parentNode.rowIndex;if(jqEvent.metaKey){var arrayIndex=jQuery.inArray(this.clickedRowId,this.rowsToSelect);if(arrayIndex>=0){this.rowsToSelect.splice(arrayIndex,1);}else{this.rowsToSelect.push(this.clickedRowId);}}else if(jqEvent.shiftKey){this.rowsToSelect.sort(function(a,b){return a-b;});var start=this.rowsToSelect[0];var end=this.clickedRowId;if(start>end){start=end;end=this.rowsToSelect[0];}
this.rowsToSelect=[];for(var i=start;i<=end;i++){this.rowsToSelect.push(i);}}else{this.rowsToSelect=[this.clickedRowId];}
this.selectRows();jqEvent.preventDefault();jqEvent.stopPropagation();this.tablePlugin.summary.focus();return false;};Table.prototype.rowSelectionMouseOver=function(jqEvent){var rowIndex=jqEvent.currentTarget.parentNode.rowIndex,indexInArray,start,end,i;if(this.mousedown&&this.clickedRowId>=0){indexInArray=jQuery.inArray(rowIndex,this.rowsToSelect);start=(rowIndex<this.clickedRowId)?rowIndex:this.clickedRowId;end=(rowIndex<this.clickedRowId)?this.clickedRowId:rowIndex;this.rowsToSelect=new Array();for(i=start;i<=end;i++){this.rowsToSelect.push(i);}
this.selectRows();jqEvent.preventDefault();jqEvent.stopPropagation();return false;}};Table.prototype.attachSelectionRow=function(){var that=this;var emptyCell=jQuery('<td>');emptyCell.html('\u00a0');var numColumns=0;for(var i=0;i<this.obj.context.rows.length;i++){var curNumColumns=0;for(var j=0;j<this.obj.context.rows[i].cells.length;j++){var colspan=Utils.colspan(this.obj.context.rows[i].cells[j]);curNumColumns+=colspan;}
if(numColumns<curNumColumns){numColumns=curNumColumns;}}
var selectionRow=jQuery('<tr>');selectionRow.addClass(this.get('classSelectionRow'));selectionRow.css('height',this.get('selectionArea')+'px');for(var i=0;i<numColumns;i++){var columnToInsert=emptyCell.clone();if(i>0){this.attachColumnSelectEventsToCell(columnToInsert);}else{var columnToInsert=jQuery('<td>').clone();columnToInsert.addClass(this.get('classLeftUpperCorner'));var clickHandler=function(e){that.focus();that.selection.selectAll();that.tablePlugin.activeTable.selection.selectionType='cell';that.tablePlugin.updateFloatingMenuScope();that._removeCursorSelection();if(that.tablePlugin.settings.summaryinsidebar){that.tablePlugin.sidebar.open();that.tablePlugin.sidebarPanel.activate(that.obj);that.tablePlugin.sidebar.correctHeight();}
try{that.tablePlugin.summary.focus();e.stopPropagation();e.preventDefault();}catch(e){}
return false;};this.wai=jQuery('<div/>').width(25).height(12).click(clickHandler);columnToInsert.append(this.wai);}
selectionRow.append(columnToInsert);}
jQuery(document).bind('mouseup',function(e){that.columnSelectionMouseUp(e)});this.obj.find('tr:first').before(selectionRow);};Table.prototype.attachColumnSelectEventsToCell=function(cell){var that=this;cell.unbind('mousedown');cell.unbind('mouseover');cell.get(0).onselectstart=function(){return false;};cell.bind('mousedown',function(e){that.columnSelectionMouseDown(e)});cell.bind('mouseover',function(e){that.columnSelectionMouseOver(e)});};Table.prototype.columnSelectionMouseDown=function(jqEvent){this.focus();if(this.selection.selectedCells.length==0){this.columnsToSelect=[];}
this.clickedColumnId=jQuery(jqEvent.currentTarget.parentNode).children().index(jqEvent.currentTarget);if(jqEvent.metaKey){var arrayIndex=jQuery.inArray(this.clickedColumnId,this.columnsToSelect);if(arrayIndex>=0){this.columnsToSelect.splice(arrayIndex,1);}else{this.columnsToSelect.push(this.clickedColumnId);}}else if(jqEvent.shiftKey){this.columnsToSelect.sort(function(a,b){return a-b;});var start=this.columnsToSelect[0];var end=this.clickedColumnId;if(start>end){start=end;end=this.columnsToSelect[0];}
this.columnsToSelect=[];for(var i=start;i<=end;i++){this.columnsToSelect.push(i);}}else{this.columnsToSelect=[this.clickedColumnId];}
this.selectColumns();jqEvent.preventDefault();jqEvent.stopPropagation();return false;};Table.prototype.columnSelectionMouseOver=function(jqEvent){var
colIdx=jqEvent.currentTarget.cellIndex,columnsToSelect=[],start,end;if(this.mouseDownColIdx){start=(colIdx<this.mouseDownColIdx)?colIdx:this.mouseDownColIdx;end=(colIdx<this.mouseDownColIdx)?this.mouseDownColIdx:colIdx;for(var i=start;i<=end;i++){columnsToSelect.push(i);}
this.selectColumns(columnsToSelect);}};Table.prototype.columnSelectionMouseUp=function(jqEvent){this.mouseDownColIdx=false;};Table.prototype.deleteRows=function(){var
rowIDs=[],rowsToDelete={},table=this;if(0===this.selection.selectedCells.length){return;}
for(var i=0;i<this.selection.selectedCells.length;i++){rowsToDelete[this.selection.selectedCells[i].parentNode.rowIndex]=true;}
for(rowId in rowsToDelete){rowIDs.push(rowId);}
var deleteTable=false;if(rowIDs.length==this.numRows){deleteTable=true;}
if(deleteTable){var that=this;Dialog.confirm({title:i18n.t('Table'),text:i18n.t('deletetable.confirm'),yes:function(){that.deleteTable();}});}else{rowIDs.sort(function(a,b){return a-b;});var focusRowId=rowIDs[0];if(focusRowId>(this.numRows-rowIDs.length)){focusRowId--;}
var rows=this.getRows();jQuery.each(rowIDs,function(unused,rowId){var row=rows[rowId];for(var i=0;i<row.cells.length;i++){Utils.splitCell(row.cells[i],function(){return table.newActiveCell().obj;});}});var grid=Utils.makeGrid(rows);jQuery.each(rowIDs,function(unused,rowId){var row=grid[rowId];for(var j=0;j<row.length;){var cellInfo=row[j];var rowspan=Utils.rowspan(cellInfo.cell);if(1<rowspan){jQuery(cellInfo.cell).attr('rowspan',rowspan-1);}
j+=cellInfo.colspan;}
jQuery(rows[rowId]).remove();});this.numRows-=rowIDs.length;window.setTimeout(function(){var lastCell=jQuery(rows[1].cells[focusRowId+1]);lastCell.focus();},5);this.selection.unselectCells();}};Table.prototype.deleteColumns=function(){var
colIDs=[],cellToDelete=[],rows=this.getRows(),that=this,changeColspan=[],cells,cellInfo;var grid=Utils.makeGrid(rows);var selectColWidth=1;if(this.selection.selectedColumnIdxs.length==grid[0].length-selectColWidth){Dialog.confirm({title:i18n.t('Table'),text:i18n.t('deletetable.confirm'),yes:function(){that.deleteTable();}});}else{colIDs.sort(function(a,b){return a-b;});var gridColumns=this.selection.selectedColumnIdxs.sort(function(a,b){return b-a;});for(var i=0;i<gridColumns.length;i++){var gridColumn=gridColumns[i];for(var j=0;j<rows.length;j++){var cellInfo=grid[j][gridColumn];if(!cellInfo){continue;}
if(0===cellInfo.spannedX){if(1<cellInfo.colspan){var nCell=this.newActiveCell().obj;jQuery(cellInfo.cell).after(nCell);nCell.attr('rowspan',cellInfo.rowspan);nCell.attr('colspan',cellInfo.colspan-1);}
jQuery(cellInfo.cell).remove();}else{jQuery(cellInfo.cell).attr('colspan',cellInfo.colspan-1);}
j+=cellInfo.rowspan-1;}
grid=Utils.makeGrid(rows);}
this.numCols-=colIDs.length;window.setTimeout(function(){var lastCell=jQuery(rows[1].cells[1]);lastCell.focus();},5);this.selection.unselectCells();}};Table.prototype.deleteTable=function(){var deleteIndex=-1;for(var i=0;i<this.tablePlugin.TableRegistry.length;i++){if(this.tablePlugin.TableRegistry[i].obj.attr('id')==this.obj.attr('id')){deleteIndex=i;break;}}
if(deleteIndex>=0){this.deactivate();this.selection.selectionType=undefined;this.tablePlugin.TableRegistry.splice(i,1);var newRange=Aloha.Selection.rangeObject;newRange.endContainer=this.obj.get(0).parentNode;newRange.startContainer=newRange.endContainer;newRange.endOffset=GENTICS.Utils.Dom.getIndexInParent(this.obj.get(0));newRange.startOffset=newRange.endOffset;newRange.clearCaches();this.obj.remove();this.parentEditable.obj.focus();newRange.correctRange();newRange.select();}};function rowIndexFromSelection(position,selection){var newRowIndex=-1;var cellOfInterest=null;if('before'===position){cellOfInterest=selection.selectedCells[0];}else if('after'===position){var offset=selection.selectedCells.length-1;cellOfInterest=selection.selectedCells[offset];}
if(cellOfInterest&&cellOfInterest.nodeType==1){newRowIndex=cellOfInterest.parentNode.rowIndex;}
return newRowIndex;}
Table.prototype.addRowBeforeSelection=function(highlightNewRows){var newRowIndex=rowIndexFromSelection('before',this.selection);if(-1!==newRowIndex){this.addRow(newRowIndex);}};Table.prototype.addRowAfterSelection=function(){var newRowIndex=rowIndexFromSelection('after',this.selection);if(-1!==newRowIndex){this.addRow(newRowIndex+1);}};Table.prototype.addRow=function(newRowIndex){var that=this;var rowsToInsert=1;var numCols=this.countVirtualCols();var $rows=this.obj.children().children('tr');for(var j=0;j<rowsToInsert;j++){var insertionRow=jQuery('<tr>');var selectionColumn=jQuery('<td>');selectionColumn.addClass(this.get('classSelectionColumn'));this.attachRowSelectionEventsToCell(selectionColumn);insertionRow.append(selectionColumn);var grid=Utils.makeGrid($rows);var selectColOffset=1;if(newRowIndex>=grid.length){for(var i=selectColOffset;i<grid[0].length;i++){insertionRow.append(this.newActiveCell().obj);}}else{for(var i=selectColOffset;i<grid[newRowIndex].length;){var cellInfo=grid[newRowIndex][i];if(Utils.containsDomCell(cellInfo)){var colspan=cellInfo.colspan;while(colspan--){insertionRow.append(this.newActiveCell().obj);}}else{jQuery(cellInfo.cell).attr('rowspan',cellInfo.rowspan+1);}
i+=cellInfo.colspan;}}
if(newRowIndex>=$rows.length){$rows.eq($rows.length-1).after(insertionRow);}else{$rows.eq(newRowIndex).before(insertionRow);}}
this.numRows+=rowsToInsert;};Table.prototype.addColumnsRight=function(){this.addColumns('right');};Table.prototype.addColumnsLeft=function(){this.addColumns('left');};Table.prototype.addColumns=function(position){var
that=this,emptyCell=jQuery('<td>'),rows=this.getRows(),cell,currentColIdx,columnsToSelect=[],selectedColumnIdxs=this.selection.selectedColumnIdxs;if(0===selectedColumnIdxs.length){return;}
selectedColumnIdxs.sort(function(a,b){return a-b;});if(!Utils.isConsecutive(selectedColumnIdxs)){Dialog.alert({title:i18n.t('Table'),text:i18n.t('table.addColumns.nonConsecutive')});return;}
if('left'===position){currentColIdx=selectedColumnIdxs[0];for(var i=0;i<this.selection.selectedColumnIdxs.length;i++){this.selection.selectedColumnIdxs[i]+=1;}}else{currentColIdx=selectedColumnIdxs[selectedColumnIdxs.length-1];}
var grid=Utils.makeGrid(rows);for(var i=0;i<rows.length;i++){cell=emptyCell.clone();cell.html('\u00a0');if(i==0){this.attachColumnSelectEventsToCell(cell);}else{cellObj=this.newActiveCell(cell.get(0));cell=cellObj.obj;}
var leftCell=Utils.leftDomCell(grid,i,currentColIdx);if(null==leftCell){jQuery(rows[i]).prepend(cell);}else{if('left'===position&&Utils.containsDomCell(grid[i][currentColIdx])){jQuery(leftCell).before(cell);}else{jQuery(leftCell).after(cell);}}
this.numCols++;}};Table.prototype.focus=function(){if(!this.hasFocus){if(!this.parentEditable.isActive){this.parentEditable.obj.focus();}
this.tablePlugin.setFocusedTable(this);}};Table.prototype.focusOut=function(){if(this.hasFocus){this.tablePlugin.setFocusedTable(undefined);this.selection.selectionType=undefined;}};Table.prototype._removeCursorSelection=function(){var selection=Aloha.getSelection();if(!selection||!selection._nativeSelection||selection._nativeSelection._ranges.length==0){return;}
var range=selection.getRangeAt(0);if(null==range.startContainer){return;}
if(0!==jQuery(range.startContainer).closest('table').length){return;}
if(0===this.selection.selectedCells.length){return;}
var container=TableCell.getContainer(this.selection.selectedCells[0]);jQuery(container).focus();}
Table.prototype.selectColumns=function(columns){var columnsToSelect;if(columns){columnsToSelect=columns;}else{columnsToSelect=this.columnsToSelect;}
Scopes.setScope(this.tablePlugin.name+'.column');this.selection.selectColumns(columnsToSelect);this.tablePlugin._columnheaderButton.setState(this.selection.isHeader());setActiveStyle(this.selection.selectedCells,this.tablePlugin.columnConfig,this.tablePlugin.columnMSItems,this.tablePlugin.columnMSButton);this.obj.find('div.aloha-ui-table-cell-editable').blur();this.selection.notifyCellsSelected();this._removeCursorSelection();};Table.prototype.selectRows=function(){Scopes.setScope(this.tablePlugin.name+'.row');this.selection.selectRows(this.rowsToSelect);this.tablePlugin._rowheaderButton.setState(this.selection.isHeader());setActiveStyle(this.selection.selectedCells,this.tablePlugin.rowConfig,this.tablePlugin.rowMSItems,this.tablePlugin.rowMSButton);this.obj.find('div.aloha-ui-table-cell-editable').blur();this.selection.notifyCellsSelected();this._removeCursorSelection();};Table.prototype.deactivate=function(){var parent=this.obj.parent();if(parent.mahaloBlock){parent.mahaloBlock();}
this.obj.removeClass(this.get('className'));if(jQuery.trim(this.obj.attr('class'))==''){this.obj.removeAttr('class');}
this.obj.removeAttr('contenteditable');if(this.obj.parents('.'+this.get('classTableWrapper')).length){this.obj.unwrap();}
this.obj.find('tr.'+this.get('classSelectionRow')+':first').remove();var that=this;jQuery.each(this.obj.context.rows,function(){jQuery(this).children('td.'+that.get('classSelectionColumn')).remove();});this.obj.find('td, th').removeClass(this.get('classCellSelected'));this.obj.find('td, th').removeClass('aloha-table-cell_active');this.obj.find('td, th').css('cursor','');this.obj.unbind();this.obj.children('tbody').unbind();for(var i=0;i<this.cells.length;i++){var Cell=this.cells[i];Cell.deactivate();}
this.obj.find('caption div').each(function(){jQuery(this).contents().unwrap();});this.isActive=false;};Table.prototype.attachColumnResize=function(cell){var that=this;that.detachRowColResize(cell);var rows=cell.closest('tbody').children('tr');var cellRow=cell.closest('tr');var gridId=Utils.cellIndexToGridColumn(rows,rows.index(cellRow),cellRow.children().index(cell));var resizeColumns=function(pixelsMoved){var expandToWidth,reduceToWidth;Utils.walkCells(rows,function(ri,ci,gridCi,colspan,rowspan){var currentCell=jQuery(jQuery(rows[ri]).children()[ci]);if(currentCell.hasClass('aloha-table-selectrow')||currentCell.closest('tr').hasClass('aloha-table-selectcolumn')||colspan>1){return true;}
if(gridCi===gridId){if(!reduceToWidth){reduceToWidth=currentCell.width()-pixelsMoved;}
Utils.resizeCellWidth(currentCell,reduceToWidth);}else if(gridCi===gridId-1){if(!expandToWidth){expandToWidth=currentCell.width()+pixelsMoved;}
Utils.resizeCellWidth(currentCell,expandToWidth);}
return true;});};cell.bind('mousedown.resize',function(){var guide=jQuery('<div></div>');guide.css({'height':jQuery(cell).closest('tbody').innerHeight(),'width':jQuery(cell).outerWidth()-jQuery(cell).innerWidth(),'top':jQuery(cell).closest('tbody').offset().top,'left':jQuery(cell).offset().left,'position':'absolute','background-color':'#80B5F2'});jQuery('body').append(guide);Utils.getCellResizeBoundaries(gridId,rows,function(maxPageX,minPageX){that.selection.resizeMode=true;jQuery('body').bind('mousemove.dnd_col_resize',function(e){if(e.pageX>minPageX&&e.pageX<maxPageX){guide.css('left',e.pageX);}});jQuery('body').bind('mouseup.dnd_col_resize',function(e){var pixelsMoved=0;if(e.pageX<minPageX){pixelsMoved=minPageX-cell.offset().left;}else if(e.pageX>minPageX&&e.pageX<maxPageX){pixelsMoved=e.pageX-cell.offset().left;}else if(e.pageX>maxPageX){pixelsMoved=maxPageX-cell.offset().left;}
if(pixelsMoved!==0){resizeColumns(pixelsMoved);}
jQuery('body').unbind('mousemove.dnd_col_resize');jQuery('body').unbind('mouseup.dnd_col_resize');that.selection.resizeMode=false;guide.remove();});});});};Table.prototype.attachRowResize=function(cell,lastRow){var that=this;that.detachRowColResize(cell);var resizeRows=function(pixelsMoved){var expandingRow;if(lastRow){expandingRow=cell.closest('tr');}else{expandingRow=cell.closest('tr').prev('tr');}
var currentRowHeight=expandingRow.height();var expandToHeight=currentRowHeight+pixelsMoved;if(expandToHeight<0){expandToHeight=1;}
expandingRow.css('height',expandToHeight);};cell.bind('mousedown.resize',function(){var guide=jQuery('<div></div>');var guideTop=function(){if(lastRow){return cell.offset().top+cell.outerHeight();}else{return cell.offset().top;}};guide.css({'width':cell.closest('tbody').innerWidth(),'height':cell.outerHeight()-cell.innerHeight(),'top':guideTop(),'left':cell.closest('tbody').offset().left,'position':'absolute','background-color':'#80B5F2'});jQuery('body').append(guide);var minHeight=function(){if(lastRow){return cell.closest('tr').offset().top;}else{return cell.closest('tr').prev('tr').offset().top;}};that.selection.resizeMode=true;jQuery('body').bind('mousemove.dnd_row_resize',function(e){if(e.pageY>minHeight()){guide.css('top',e.pageY);}});jQuery('body').bind('mouseup.dnd_row_resize',function(e){var pixelsMoved=0;if(lastRow){pixelsMoved=e.pageY-(cell.offset().top+cell.outerHeight());}else{pixelsMoved=e.pageY-cell.offset().top;}
resizeRows(pixelsMoved);jQuery('body').unbind('mousemove.dnd_row_resize');jQuery('body').unbind('mouseup.dnd_row_resize');that.selection.resizeMode=false;guide.remove();});});};Table.prototype.attachTableResizeWidth=function(table){var that=this;var tableContainer=table.closest('.aloha-table-wrapper')
var lastColumn=table.find("tr:not(.aloha-table-selectcolumn) td:last-child")
var lastCell;jQuery.each(lastColumn,function(){if(!jQuery(this).attr('colspan')||jQuery(this).attr('colspan')<2){lastCell=jQuery(this);return false;}});lastColumn.css('cursor','col-resize');var resizeColumns=function(pixelsMoved){var rows=table.find('tr');var lastCellRow=lastCell.closest('tr');var gridId=Utils.cellIndexToGridColumn(rows,rows.index(lastCellRow),lastCellRow.children().index(lastCell));var expandToWidth=pixelsMoved-Utils.getCellBorder(lastCell)-Utils.getCellPadding(lastCell);Utils.walkCells(rows,function(ri,ci,gridCi,colspan,rowspan){var currentCell=jQuery(jQuery(rows[ri]).children()[ci])
if(currentCell.hasClass('aloha-table-selectrow')||currentCell.closest('tr').hasClass('aloha-table-selectcolumn')||colspan>1){return true;}
if(gridCi===gridId){Utils.resizeCellWidth(currentCell,expandToWidth);}else{Utils.resizeCellWidth(currentCell,currentCell.width());}
return true;});};lastColumn.bind('mousedown.resize',function(){var guide=jQuery('<div></div>');guide.css({'height':table.children('tbody').innerHeight(),'width':lastCell.outerWidth()-lastCell.innerWidth(),'top':table.find('tbody').offset().top,'left':table.offset().left+table.outerWidth(),'position':'absolute','background-color':'#80B5F2'});jQuery('body').append(guide);var maxPageX=tableContainer.offset().left+tableContainer.width();var minPageX=lastCell.offset().left+(lastCell.innerWidth()-lastCell.width())+Utils.getMinColWidth(lastCell);that.selection.resizeMode=true;jQuery('body').bind('mousemove.dnd_col_resize',function(e){if(e.pageX>minPageX&&e.pageX<maxPageX){guide.css('left',e.pageX);}});jQuery('body').bind('mouseup.dnd_col_resize',function(e){var pixelsMoved=0;if(e.pageX<=minPageX){pixelsMoved=minPageX-lastCell.offset().left;}else if(e.pageX>minPageX&&e.pageX<maxPageX){pixelsMoved=e.pageX-lastCell.offset().left;}else if(e.pageX>maxPageX){pixelsMoved=maxPageX-lastCell.offset().left;}
resizeColumns(pixelsMoved);jQuery('body').unbind('mousemove.dnd_col_resize');jQuery('body').unbind('mouseup.dnd_col_resize');lastColumn.unbind('mousedown.resize');lastColumn.css('cursor','default');that.selection.resizeMode=false;guide.remove();});});};Table.prototype.detachRowColResize=function(cell){return cell.unbind('mousedown.resize');};Table.prototype.toString=function(){return'Table';};Table.prototype.newCell=function(domElement){return new TableCell(domElement,this);};Table.prototype.newActiveCell=function(domElement){var cell=new TableCell(domElement,this);cell.activate();return cell;};Table.prototype.getRows=function(){var rows=this.obj.get(0).rows;return jQuery.makeArray(rows);};return Table;});