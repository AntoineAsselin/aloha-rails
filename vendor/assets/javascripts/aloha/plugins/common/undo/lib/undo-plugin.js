
define(['aloha','jquery','aloha/plugin','undo/vendor/undo','undo/vendor/diff_match_patch_uncompressed'],function(Aloha,jQuery,Plugin){"use strict";var
dmp=new diff_match_patch,resetFlag=false;function reversePatch(patch){var reversed=dmp.patch_deepCopy(patch);for(var i=0;i<reversed.length;i++){for(var j=0;j<reversed[i].diffs.length;j++){reversed[i].diffs[j][0]=-(reversed[i].diffs[j][0]);}}
return reversed;}
return Plugin.create('undo',{init:function(){this.stack=new Undo.Stack();var that=this;var EditCommand=Undo.Command.extend({constructor:function(editable,patch){this.editable=editable;this.patch=patch;},execute:function(){},undo:function(){this.phase(reversePatch(this.patch));},redo:function(){this.phase(this.patch);},phase:function(patch){var contents=this.editable.getContents(),applied=dmp.patch_apply(patch,contents),newValue=applied[0],didNotApply=applied[1];if(didNotApply.length){}
this.reset(newValue);},reset:function(val){resetFlag=true;var reactivate=null;if(Aloha.getActiveEditable()===this.editable){Aloha.deactivateEditable();reactivate=this.editable;}
this.editable.obj.html(val);if(null!==reactivate){reactivate.activate();}
this.editable.smartContentChange({type:'blur'});resetFlag=false;}});this.stack.changed=function(){};Aloha.bind('aloha-editable-created',function(e,editable){editable.obj.bind('keydown','ctrl+z shift+ctrl+z',function(event){event.preventDefault();if(event.shiftKey){that.redo();}else{that.undo();}});});Aloha.bind('aloha-smart-content-changed',function(jevent,aevent){var oldValue=aevent.getSnapshotContent();if(resetFlag){return;}
var newValue=aevent.editable.getContents(),patch=dmp.patch_make(oldValue,newValue);if(0!==patch.length){that.stack.execute(new EditCommand(aevent.editable,patch));}});},toString:function(){return'undo';},undo:function(){if(null!==Aloha.getActiveEditable()){Aloha.getActiveEditable().smartContentChange({type:'blur'});}
this.stack.canUndo()&&this.stack.undo();},redo:function(){if(null!==Aloha.getActiveEditable()){Aloha.getActiveEditable().smartContentChange({type:'blur'});}
this.stack.canRedo()&&this.stack.redo();},stack:undefined});});