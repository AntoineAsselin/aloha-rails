
window.GENTICS=window.GENTICS||{};window.GENTICS.Utils=window.GENTICS.Utils||{};define(['jquery','util/class','aloha/ecma5shims'],function(jQuery,Class,$_){"use strict";var GENTICS=window.GENTICS,Node={'ELEMENT_NODE':1,'ATTRIBUTE_NODE':2,'TEXT_NODE':3,'CDATA_SECTION_NODE':4,'ENTITY_REFERENCE_NODE':5,'ENTITY_NODE':6,'PROCESSING_INSTRUCTION_NODE':7,'COMMENT_NODE':8,'DOCUMENT_NODE':9,'DOCUMENT_TYPE_NODE':10,'DOCUMENT_FRAGMENT_NODE':11,'NOTATION_NODE':12,'DOCUMENT_POSITION_DISCONNECTED':0x01,'DOCUMENT_POSITION_PRECEDING':0x02,'DOCUMENT_POSITION_FOLLOWING':0x04,'DOCUMENT_POSITION_CONTAINS':0x08,'DOCUMENT_POSITION_CONTAINED_BY':0x10,'DOCUMENT_POSITION_IMPLEMENTATION_SPECIFIC':0x20},blockElementNames={'P':true,'H1':true,'H2':true,'H3':true,'H4':true,'H5':true,'H6':true,'LI':true};var Dom=Class.extend({wordRegex:/[\u0041-\u005A\u0061-\u007A\u00AA\u00B5\u00BA\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0370-\u0374\u0376\u0377\u037A-\u037D\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u0525\u0531-\u0556\u0559\u0561-\u0587\u05D0-\u05EA\u05F0-\u05F2\u0621-\u064A\u066E\u066F\u0671-\u06D3\u06D5\u06E5\u06E6\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u07F4\u07F5\u07FA\u0800-\u0815\u081A\u0824\u0828\u0904-\u0939\u093D\u0950\u0958-\u0961\u0971\u0972\u0979-\u097F\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09F0\u09F1\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C33\u0C35-\u0C39\u0C3D\u0C58\u0C59\u0C60\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0\u0CE1\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D28\u0D2A-\u0D39\u0D3D\u0D60\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E46\u0E81\u0E82\u0E84\u0E87\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA\u0EAB\u0EAD-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EC6\u0EDC\u0EDD\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8B\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u10A0-\u10C5\u10D0-\u10FA\u10FC\u1100-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17D7\u17DC\u1820-\u1877\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191C\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19C1-\u19C7\u1A00-\u1A16\u1A20-\u1A54\u1AA7\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE\u1BAF\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C7D\u1CE9-\u1CEC\u1CEE-\u1CF1\u1D00-\u1DBF\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2071\u207F\u2090-\u2094\u2102\u2107\u210A-\u2113\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u212F-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2183\u2184\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CEE\u2D00-\u2D25\u2D30-\u2D65\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2E2F\u3005\u3006\u3031-\u3035\u303B\u303C\u3041-\u3096\u309D-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31B7\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCB\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA61F\uA62A\uA62B\uA640-\uA65F\uA662-\uA66E\uA67F-\uA697\uA6A0-\uA6E5\uA717-\uA71F\uA722-\uA788\uA78B\uA78C\uA7FB-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9CF\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA76\uAA7A\uAA80-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADD\uABC0-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA2D\uFA30-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF21-\uFF3A\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]/,nonWordRegex:/[^\u0041-\u005A\u0061-\u007A\u00AA\u00B5\u00BA\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0370-\u0374\u0376\u0377\u037A-\u037D\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u0525\u0531-\u0556\u0559\u0561-\u0587\u05D0-\u05EA\u05F0-\u05F2\u0621-\u064A\u066E\u066F\u0671-\u06D3\u06D5\u06E5\u06E6\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u07F4\u07F5\u07FA\u0800-\u0815\u081A\u0824\u0828\u0904-\u0939\u093D\u0950\u0958-\u0961\u0971\u0972\u0979-\u097F\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09F0\u09F1\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C33\u0C35-\u0C39\u0C3D\u0C58\u0C59\u0C60\u0C61\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0\u0CE1\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D28\u0D2A-\u0D39\u0D3D\u0D60\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E46\u0E81\u0E82\u0E84\u0E87\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA\u0EAB\u0EAD-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EC6\u0EDC\u0EDD\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8B\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u10A0-\u10C5\u10D0-\u10FA\u10FC\u1100-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F4\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17D7\u17DC\u1820-\u1877\u1880-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191C\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19C1-\u19C7\u1A00-\u1A16\u1A20-\u1A54\u1AA7\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE\u1BAF\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C7D\u1CE9-\u1CEC\u1CEE-\u1CF1\u1D00-\u1DBF\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2071\u207F\u2090-\u2094\u2102\u2107\u210A-\u2113\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u212F-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2183\u2184\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CEE\u2D00-\u2D25\u2D30-\u2D65\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2E2F\u3005\u3006\u3031-\u3035\u303B\u303C\u3041-\u3096\u309D-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31B7\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FCB\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA61F\uA62A\uA62B\uA640-\uA65F\uA662-\uA66E\uA67F-\uA697\uA6A0-\uA6E5\uA717-\uA71F\uA722-\uA788\uA78B\uA78C\uA7FB-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9CF\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA76\uAA7A\uAA80-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADD\uABC0-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA2D\uFA30-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF21-\uFF3A\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC]/,mergeableTags:['b','code','del','em','i','ins','strong','sub','sup','#text'],nonWordBoundaryTags:['a','b','code','del','em','i','ins','span','strong','sub','sup','#text'],nonEmptyTags:['br'],tags:{'flow':['a','abbr','address','area','article','aside','audio','b','bdi','bdo','blockquote','br','button','canvas','cite','code','command','datalist','del','details','dfn','div','dl','em','embed','fieldset','figure','footer','form','h1','h2','h3','h4','h5','h6','header','hgroup','hr','i','iframe','img','input','ins','kbd','keygen','label','map','mark','math','menu','meter','nav','noscript','object','ol','output','p','pre','progress','q','ruby','s','samp','script','section','select','small','span','strong','style','sub','sup','svg','table','textarea','time','u','ul','var','video','wbr','#text'],'phrasing':['a','abbr','area','audio','b','bdi','bdo','br','button','canvas','cite','code','command','datalist','del','dfn','em','embed','i','iframe','img','input','ins','kbd','keygen','label','map','mark','math','meter','noscript','object','output','progress','q','ruby','samp','script','select','small','span','strong','sub','sup','svg','textarea','time','u','var','video','wbr','#text']},children:{'a':'phrasing','abbr':'phrasing','address':'flow','area':'empty','article':'flow','aside':'flow','audio':'source','b':'phrasing','base':'empty','bdo':'phrasing','blockquote':'phrasing','body':'flow','br':'empty','button':'phrasing','canvas':'phrasing','caption':'flow','cite':'phrasing','code':'phrasing','col':'empty','colgroup':'col','command':'empty','datalist':['phrasing','option'],'dd':'flow','del':'phrasing','div':'flow','details':['summary','flow'],'dfn':'flow','dl':['dt','dd'],'dt':'phrasing','em':'phrasing','embed':'empty','fieldset':['legend','flow'],'figcaption':'flow','figure':['figcaption','flow'],'footer':'flow','form':'flow','h1':'phrasing','h2':'phrasing','h3':'phrasing','h4':'phrasing','h5':'phrasing','h6':'phrasing','header':'flow','hgroup':['h1','h2','h3','h4','h5','h6'],'hr':'empty','i':'phrasing','iframe':'#text','img':'empty','input':'empty','ins':'phrasing','kbd':'phrasing','keygen':'empty','label':'phrasing','legend':'phrasing','li':'flow','link':'empty','map':'area','mark':'phrasing','menu':['li','flow'],'meta':'empty','meter':'phrasing','nav':'flow','noscript':'phrasing','object':'param','ol':'li','optgroup':'option','option':'#text','output':'phrasing','p':'phrasing','param':'empty','pre':'phrasing','progress':'phrasing','q':'phrasing','rp':'phrasing','rt':'phrasing','ruby':['phrasing','rt','rp'],'s':'phrasing','samp':'pharsing','script':'#script','section':'flow','select':['option','optgroup'],'small':'phrasing','source':'empty','span':'phrasing','strong':'phrasing','style':'phrasing','sub':'phrasing','summary':'phrasing','sup':'phrasing','table':['caption','colgroup','thead','tbody','tfoot','tr'],'tbody':'tr','td':'flow','textarea':'#text','tfoot':'tr','th':'phrasing','thead':'tr','time':'phrasing','title':'#text','tr':['th','td'],'track':'empty','u':'phrasing','ul':'li','var':'phrasing','video':'source','wbr':'empty'},blockLevelElements:['p','h1','h2','h3','h4','h5','h6','blockquote','div','pre'],listElements:['li','ol','ul'],split:function(range,limit,atEnd){var splitElement=jQuery(range.startContainer),splitPosition=range.startOffset,updateRange,path,parents,newDom,insertElement,secondPart,i,pathLength,element,jqelement,children,newElement,next,prev,offset;if(atEnd){splitElement=jQuery(range.endContainer);splitPosition=range.endOffset;}
if(limit.length<1){limit=jQuery(document.body);}
updateRange=(!range.isCollapsed()&&!atEnd);parents=splitElement.parents().get();parents.unshift(splitElement.get(0));jQuery.each(parents,function(index,element){var isLimit=limit.filter(function(){return this==element;}).length;if(isLimit){if(index>0){path=parents.slice(0,index);}
return false;}});if(!path){return true;}
path=path.reverse();for(i=0,pathLength=path.length;i<pathLength;++i){element=path[i];if(i===pathLength-1){if(element.nodeType===3){secondPart=document.createTextNode(element.data.substring(splitPosition,element.data.length));element.data=element.data.substring(0,splitPosition);}else{jqelement=jQuery(element);children=jqelement.contents();newElement=jqelement.clone(false).empty();secondPart=newElement.append(children.slice(splitPosition,children.length)).get(0);}
if(updateRange&&range.endContainer===element){range.endContainer=secondPart;range.endOffset-=splitPosition;range.clearCaches();}
if(insertElement){insertElement.prepend(secondPart);}else{jQuery(element).after(secondPart);}}else{newElement=jQuery(element).clone(false).empty();if(!newDom){newDom=newElement;}else{insertElement.prepend(newElement);}
insertElement=newElement;while(true){next=path[i+1].nextSibling;if(!next){break;}
insertElement.append(next);}
if(updateRange&&range.endContainer===element){range.endContainer=newElement.get(0);prev=path[i+1];offset=0;while(true){prev=prev.previousSibling;if(!prev){break;}
offset++;}
range.endOffset-=offset;range.clearCaches();}}}
jQuery(path[0]).after(newDom);return jQuery([path[0],newDom?newDom.get(0):secondPart]);},allowsNesting:function(outerDOMObject,innerDOMObject){if(!outerDOMObject||!outerDOMObject.nodeName||!innerDOMObject||!innerDOMObject.nodeName){return false;}
var outerNodeName=outerDOMObject.nodeName.toLowerCase(),innerNodeName=innerDOMObject.nodeName.toLowerCase();if(!this.children[outerNodeName]){return false;}
if(this.children[outerNodeName]==innerNodeName){return true;}
if(jQuery.isArray(this.children[outerNodeName])&&jQuery.inArray(innerNodeName,this.children[outerNodeName])>=0){return true;}
if(jQuery.isArray(this.tags[this.children[outerNodeName]])&&jQuery.inArray(innerNodeName,this.tags[this.children[outerNodeName]])>=0){return true;}
return false;},addMarkup:function(rangeObject,markup,nesting){if(rangeObject.startContainer.nodeType===3&&rangeObject.startOffset>0&&rangeObject.startOffset<rangeObject.startContainer.data.length){this.split(rangeObject,jQuery(rangeObject.startContainer).parent(),false);}
if(rangeObject.endContainer.nodeType===3&&rangeObject.endOffset>0&&rangeObject.endOffset<rangeObject.endContainer.data.length){this.split(rangeObject,jQuery(rangeObject.endContainer).parent(),true);}
var rangeTree=rangeObject.getRangeTree();this.recursiveAddMarkup(rangeTree,markup,rangeObject,nesting);this.doCleanup({'merge':true,'removeempty':true},rangeObject);},recursiveAddMarkup:function(rangeTree,markup,rangeObject,nesting){var i,innerRange,rangeLength;for(i=0,rangeLength=rangeTree.length;i<rangeLength;++i){if(rangeTree[i].type=='full'&&this.allowsNesting(markup.get(0),rangeTree[i].domobj)){if((nesting||rangeTree[i].domobj.nodeName!=markup.get(0).nodeName)&&(rangeTree[i].domobj.nodeType!==3||jQuery.trim(rangeTree[i].domobj.data).length!==0)){jQuery(rangeTree[i].domobj).wrap(markup);if(!nesting&&rangeTree[i].domobj.nodeType!==3){innerRange=new GENTICS.Utils.RangeObject();innerRange.startContainer=innerRange.endContainer=rangeTree[i].domobj.parentNode;innerRange.startOffset=0;innerRange.endOffset=innerRange.endContainer.childNodes.length;this.removeMarkup(innerRange,markup,jQuery(rangeTree[i].domobj.parentNode));}}}else{if((nesting||(rangeTree[i].domobj&&rangeTree[i].domobj.nodeName!==markup.get(0).nodeName))&&rangeTree[i].children&&rangeTree[i].children.length>0){this.recursiveAddMarkup(rangeTree[i].children,markup);}}}},findHighestElement:function(start,nodeName,limit){nodeName=nodeName.toLowerCase();var highestObject,testObject=start,isLimit=limit?function(){return limit.filter(function(){return testObject==this;}).length;}:function(){return false;};while(!isLimit()&&testObject){if(testObject.nodeName.toLowerCase()===nodeName){highestObject=testObject;}
testObject=testObject.parentNode;}
return highestObject;},removeMarkup:function(rangeObject,markup,limit){var nodeName=markup.get(0).nodeName,startSplitLimit=this.findHighestElement(rangeObject.startContainer,nodeName,limit),endSplitLimit=this.findHighestElement(rangeObject.endContainer,nodeName,limit),didSplit=false,highestObject,root,rangeTree;if(startSplitLimit&&rangeObject.startOffset>0){this.split(rangeObject,jQuery(startSplitLimit).parent(),false);didSplit=true;}
if(endSplitLimit){if(rangeObject.endContainer.nodeType===3&&rangeObject.endOffset<rangeObject.endContainer.data.length){this.split(rangeObject,jQuery(endSplitLimit).parent(),true);didSplit=true;}
if(rangeObject.endContainer.nodeType===1&&rangeObject.endOffset<rangeObject.endContainer.childNodes.length){this.split(rangeObject,jQuery(endSplitLimit).parent(),true);didSplit=true;}}
if(didSplit){rangeObject.correctRange();}
highestObject=this.findHighestElement(rangeObject.getCommonAncestorContainer(),nodeName,limit);root=highestObject?highestObject.parentNode:rangeObject.getCommonAncestorContainer();if(root){rangeTree=rangeObject.getRangeTree(root);this.recursiveRemoveMarkup(rangeTree,markup);this.doCleanup({'merge':true,'removeempty':true},rangeObject,root);}},recursiveRemoveMarkup:function(rangeTree,markup){var i,rangeLength,content;for(i=0,rangeLength=rangeTree.length;i<rangeLength;++i){if(rangeTree[i].type=='full'&&rangeTree[i].domobj.nodeName==markup.get(0).nodeName){content=jQuery(rangeTree[i].domobj).contents();if(content.length>0){content.first().unwrap();}else{jQuery(rangeTree[i].domobj).remove();}}
if(rangeTree[i].children){this.recursiveRemoveMarkup(rangeTree[i].children,markup);}}},doCleanup:function(cleanup,rangeObject,start){var that=this,prevNode,modifiedRange,startObject,startOffset,endOffset;if(typeof cleanup==='undefined'){cleanup={};}
if(typeof cleanup.merge==='undefined'){cleanup.merge=false;}
if(typeof cleanup.removeempty==='undefined'){cleanup.removeempty=false;}
if(typeof start==='undefined'&&rangeObject){start=rangeObject.getCommonAncestorContainer();}
prevNode=false;modifiedRange=false;startObject=jQuery(start);startOffset=rangeObject.startOffset;endOffset=rangeObject.endOffset;startObject.contents().each(function(){var index;var nodeType;try{nodeType=this.nodeType;index=that.getIndexInParent(this);}catch(e){return;}
switch(nodeType){case 1:if(prevNode&&prevNode.nodeName==this.nodeName){if(rangeObject.startContainer===startObject&&startOffset>index){rangeObject.startOffset-=1;modifiedRange=true;}
if(rangeObject.endContainer===startObject&&endOffset>index){rangeObject.endOffset-=1;modifiedRange=true;}
jQuery(prevNode).append(jQuery(this).contents());modifiedRange|=that.doCleanup(cleanup,rangeObject,prevNode);jQuery(this).remove();}else{modifiedRange|=that.doCleanup(cleanup,rangeObject,this);var removed=false;if(cleanup.removeempty){if(GENTICS.Utils.Dom.isBlockLevelElement(this)&&this.childNodes.length===0){removed=true;}
if(jQuery.inArray(this.nodeName.toLowerCase(),that.mergeableTags)>=0&&jQuery(this).text().length===0&&this.childNodes.length===0){removed=true;}}
if(!removed){if(cleanup.mergeable?cleanup.mergeable(this):jQuery.inArray(this.nodeName.toLowerCase(),that.mergeableTags)>=0){prevNode=this;}else{prevNode=false;}}else{if(rangeObject.startContainer===this.parentNode&&startOffset>index){rangeObject.startOffset=rangeObject.startOffset-1;modifiedRange=true;}
if(rangeObject.endContainer===this.parentNode&&endOffset>index){rangeObject.endOffset=rangeObject.endOffset-1;modifiedRange=true;}
jQuery(this).remove();}}
break;case 3:if(prevNode&&prevNode.nodeType===3&&cleanup.merge){if(rangeObject.startContainer===this){rangeObject.startContainer=prevNode;rangeObject.startOffset+=prevNode.nodeValue.length;modifiedRange=true;}else if(rangeObject.startContainer===prevNode.parentNode&&rangeObject.startOffset===that.getIndexInParent(prevNode)+1){rangeObject.startContainer=prevNode;rangeObject.startOffset=prevNode.nodeValue.length;modifiedRange=true;}
if(rangeObject.endContainer===this){rangeObject.endContainer=prevNode;rangeObject.endOffset+=prevNode.nodeValue.length;modifiedRange=true;}else if(rangeObject.endContainer===prevNode.parentNode&&rangeObject.endOffset===that.getIndexInParent(prevNode)+1){rangeObject.endContainer=prevNode;rangeObject.endOffset=prevNode.nodeValue.length;modifiedRange=true;}
prevNode.data+=this.data;}else if(!(this.nodeValue===''&&cleanup.removeempty)){prevNode=this;break;}
if(rangeObject.startContainer===this.parentNode&&rangeObject.startOffset>index){rangeObject.startOffset=rangeObject.startOffset-1;modifiedRange=true;}
if(rangeObject.endContainer===this.parentNode&&rangeObject.endOffset>index){rangeObject.endOffset=rangeObject.endOffset-1;modifiedRange=true;}
jQuery(this).remove();if(prevNode&&(!prevNode.nextSibling||prevNode.nextSibling.nodeType!==3)){var pos;for(pos=prevNode.data.length-1;pos>=0&&prevNode.data.length>1;pos--){if(prevNode.data.charAt(pos)==='\u200b'){prevNode.deleteData(pos,1);if(rangeObject.startContainer===prevNode&&rangeObject.startOffset>pos){rangeObject.startOffset--;modifiedRange=true;}
if(rangeObject.endContainer===prevNode&&rangeObject.endOffset>pos){rangeObject.endOffset--;modifiedRange=true;}}}}
break;}});if(modifiedRange){rangeObject.clearCaches();}
return modifiedRange;},getIndexInParent:function(node){if(!node){return false;}
var index=0,check=node.previousSibling;while(check){index++;check=check.previousSibling;}
return index;},isBlockLevelElement:function(node){if(!node){return false;}
if(node.nodeType===1&&jQuery.inArray(node.nodeName.toLowerCase(),this.blockLevelElements)>=0){return true;}
return false;},isLineBreakElement:function(node){if(!node){return false;}
return node.nodeType===1&&node.nodeName.toLowerCase()=='br';},isListElement:function(node){if(!node){return false;}
return node.nodeType===1&&jQuery.inArray(node.nodeName.toLowerCase(),this.listElements)>=0;},isSplitObject:function(el){return el.nodeType===1&&blockElementNames.hasOwnProperty(el.nodeName);},searchAdjacentTextNode:function(parent,index,searchleft,stopat){if(!parent||parent.nodeType!==1||index<0||index>parent.childNodes.length){return false;}
if(typeof stopat==='undefined'){stopat={'blocklevel':true,'list':true,'linebreak':true};}
if(typeof stopat.blocklevel==='undefined'){stopat.blocklevel=true;}
if(typeof stopat.list==='undefined'){stopat.list=true;}
if(typeof stopat.linebreak==='undefined'){stopat.linebreak=true;}
if(typeof searchleft==='undefined'){searchleft=true;}
var nextNode,currentParent=parent;if(searchleft&&index>0){nextNode=parent.childNodes[index-1];}
if(!searchleft&&index<parent.childNodes.length){nextNode=parent.childNodes[index];}
while(currentParent){if(!nextNode){if(stopat.blocklevel&&this.isBlockLevelElement(currentParent)){return false;}
if(stopat.list&&this.isListElement(currentParent)){return false;}
nextNode=searchleft?currentParent.previousSibling:currentParent.nextSibling;currentParent=currentParent.parentNode;continue;}else if(nextNode.nodeType===3&&jQuery.trim(nextNode.data).length>0){return nextNode;}
if(stopat.blocklevel&&this.isBlockLevelElement(nextNode)){return false;}
if(stopat.linebreak&&this.isLineBreakElement(nextNode)){return false;}
if(stopat.list&&this.isListElement(nextNode)){return false;}
if(nextNode.nodeType===3){nextNode=searchleft?nextNode.previousSibling:nextNode.nextSibling;}else{currentParent=nextNode;nextNode=searchleft?nextNode.lastChild:nextNode.firstChild;}}},insertIntoDOM:function(object,range,limit,atEnd,force){var parentElements=range.getContainerParents(limit,atEnd),that=this,newParent,container,offset,splitParts,contents;if(!limit){limit=jQuery(document.body);}
if(parentElements.length===0){newParent=limit.get(0);}else{jQuery.each(parentElements,function(index,parent){if(that.allowsNesting(parent,object.get(0))){newParent=parent;return false;}});}
if(typeof newParent==='undefined'&&limit.length>0){newParent=limit.get(0);}
if(!this.allowsNesting(newParent,object.get(0))&&!force){return false;}
if(typeof newParent!=='undefined'){splitParts=this.split(range,jQuery(newParent),atEnd);if(splitParts===true){container=range.startContainer;offset=range.startOffset;if(atEnd){container=range.endContainer;offset=range.endOffset;}
if(offset===0){contents=jQuery(container).contents();if(contents.length>0){contents.eq(0).before(object);}else{jQuery(container).append(object);}
return true;}
jQuery(container).contents().eq(offset-1).after(object);return true;}
if(splitParts){splitParts.eq(0).after(object);return true;}
return false;}
return false;},removeFromDOM:function(object,range,preserveContent){if(preserveContent){var indexInParent=this.getIndexInParent(object),numChildren=jQuery(object).contents().length,parent=object.parentNode;if(range.startContainer==parent&&range.startOffset>indexInParent){range.startOffset+=numChildren-1;}else if(range.startContainer==object){range.startContainer=parent;range.startOffset=indexInParent+range.startOffset;}
if(range.endContainer==parent&&range.endOffset>indexInParent){range.endOffset+=numChildren-1;}else if(range.endContainer==object){range.endContainer=parent;range.endOffset=indexInParent+range.endOffset;}
jQuery(object).contents().unwrap();this.doCleanup({'merge':true},range,parent);}},removeRange:function(rangeObject){if(!rangeObject){return false;}
if(rangeObject.isCollapsed()){return false;}
if(rangeObject.startContainer.nodeType==3&&rangeObject.startOffset>0&&rangeObject.startOffset<rangeObject.startContainer.data.length){this.split(rangeObject,jQuery(rangeObject.startContainer).parent(),false);}
if(rangeObject.endContainer.nodeType==3&&rangeObject.endOffset>0&&rangeObject.endOffset<rangeObject.endContainer.data.length){this.split(rangeObject,jQuery(rangeObject.endContainer).parent(),true);}
var rangeTree=rangeObject.getRangeTree();rangeObject.endContainer=rangeObject.startContainer;rangeObject.endOffset=rangeObject.startOffset;this.recursiveRemoveRange(rangeTree,rangeObject);this.doCleanup({'merge':true},rangeObject);rangeObject.clearCaches();},recursiveRemoveRange:function(rangeTree,rangeObject){var i;for(i=0;i<rangeTree.length;++i){if(rangeTree[i].type=='full'){if(jQuery(rangeObject.startContainer).parents().andSelf().filter(rangeTree[i].domobj).length>0){rangeObject.startContainer=rangeObject.endContainer=rangeTree[i].domobj.parentNode;rangeObject.startOffset=rangeObject.endOffset=this.getIndexInParent(rangeTree[i].domobj);}
jQuery(rangeTree[i].domobj).remove();}else if(rangeTree[i].type=='partial'&&rangeTree[i].children){this.recursiveRemoveRange(rangeTree[i].children,rangeObject);}}},extendToWord:function(range,fromBoundaries){var leftBoundary=this.searchWordBoundary(range.startContainer,range.startOffset,true),rightBoundary=this.searchWordBoundary(range.endContainer,range.endOffset,false);if(!fromBoundaries){if(range.startContainer==leftBoundary.container&&range.startOffset==leftBoundary.offset){return;}
if(range.endContainer==rightBoundary.container&&range.endOffset==rightBoundary.offset){return;}}
range.startContainer=leftBoundary.container;range.startOffset=leftBoundary.offset;range.endContainer=rightBoundary.container;range.endOffset=rightBoundary.offset;range.correctRange();range.clearCaches();},isWordBoundaryElement:function(object){if(!object||!object.nodeName){return false;}
return jQuery.inArray(object.nodeName.toLowerCase(),this.nonWordBoundaryTags)==-1;},searchWordBoundary:function(container,offset,searchleft){if(typeof searchleft==='undefined'){searchleft=true;}
var boundaryFound=false,wordBoundaryPos,tempWordBoundaryPos,textNode;while(!boundaryFound){if(container.nodeType===3){if(!searchleft){wordBoundaryPos=container.data.substring(offset).search(this.nonWordRegex);if(wordBoundaryPos!=-1){offset=offset+wordBoundaryPos;boundaryFound=true;}else{offset=this.getIndexInParent(container)+1;container=container.parentNode;}}else{wordBoundaryPos=container.data.substring(0,offset).search(this.nonWordRegex);tempWordBoundaryPos=wordBoundaryPos;while(tempWordBoundaryPos!=-1){wordBoundaryPos=tempWordBoundaryPos;tempWordBoundaryPos=container.data.substring(wordBoundaryPos+1,offset).search(this.nonWordRegex);if(tempWordBoundaryPos!=-1){tempWordBoundaryPos=tempWordBoundaryPos+wordBoundaryPos+1;}}
if(wordBoundaryPos!=-1){offset=wordBoundaryPos+1;boundaryFound=true;}else{offset=this.getIndexInParent(container);container=container.parentNode;}}}else if(container.nodeType===1){if(!searchleft){if(offset<container.childNodes.length){if(this.isWordBoundaryElement(container.childNodes[offset])){boundaryFound=true;}else{container=container.childNodes[offset];offset=0;}}else{if(this.isWordBoundaryElement(container)){boundaryFound=true;}else{offset=this.getIndexInParent(container)+1;container=container.parentNode;}}}else{if(offset>0){if(this.isWordBoundaryElement(container.childNodes[offset-1])){boundaryFound=true;}else{container=container.childNodes[offset-1];offset=container.nodeType===3?container.data.length:container.childNodes.length;}}else{if(this.isWordBoundaryElement(container)){boundaryFound=true;}else{offset=this.getIndexInParent(container);container=container.parentNode;}}}}}
if(container.nodeType!==3){textNode=this.searchAdjacentTextNode(container,offset,!searchleft);if(textNode){container=textNode;offset=searchleft?0:container.data.length;}}
return{'container':container,'offset':offset};},isEmpty:function(domObject){if(!domObject){return true;}
if(jQuery.inArray(domObject.nodeName.toLowerCase(),this.nonEmptyTags)!=-1){return false;}
if(domObject.nodeType===3){return domObject.data.search(/\S/)==-1;}
var i,childNodes;for(i=0,childNodes=domObject.childNodes.length;i<childNodes;++i){if(!this.isEmpty(domObject.childNodes[i])){return false;}}
return true;},setCursorAfter:function(domObject){var newRange=new GENTICS.Utils.RangeObject(),index=this.getIndexInParent(domObject),targetNode,offset;if(domObject.nodeType==3){targetNode=domObject;offset=targetNode.nodeValue.length;}else if(domObject.nextSibling&&domObject.nextSibling.nodeType==3){targetNode=domObject.nextSibling;offset=0;}else{targetNode=domObject.parentNode;offset=this.getIndexInParent(domObject)+1;}
newRange.startContainer=newRange.endContainer=targetNode;newRange.startOffset=newRange.endOffset=offset;newRange.select();return newRange;},selectDomNode:function(domObject){var newRange=new GENTICS.Utils.RangeObject();newRange.startContainer=newRange.endContainer=domObject.parentNode;newRange.startOffset=this.getIndexInParent(domObject);newRange.endOffset=newRange.startOffset+1;newRange.select();},setCursorInto:function(domObject){var newRange=new GENTICS.Utils.RangeObject();newRange.startContainer=newRange.endContainer=domObject;newRange.startOffset=newRange.endOffset=0;newRange.select();},isEditingHost:function(node){return node&&node.nodeType==1&&(node.contentEditable=="true"||(node.parentNode&&node.parentNode.nodeType==9&&node.parentNode.designMode=="on"));},isEditable:function(node){return node&&!this.isEditingHost(node)&&(node.nodeType!=1||node.contentEditable!="false")&&(this.isEditingHost(node.parentNode)||this.isEditable(node.parentNode));},getEditingHostOf:function(node){if(this.isEditingHost(node)){return node;}
if(this.isEditable(node)){var ancestor=node.parentNode;while(!this.isEditingHost(ancestor)){ancestor=ancestor.parentNode;}
return ancestor;}
return null;},inSameEditingHost:function(node1,node2){return this.getEditingHostOf(node1)&&this.getEditingHostOf(node1)==this.getEditingHostOf(node2);},isBlockNode:function(node){return node&&((node.nodeType==$_.Node.ELEMENT_NODE&&$_(["inline","inline-block","inline-table","none"]).indexOf($_.getComputedStyle(node).display)==-1)||node.nodeType==$_.Node.DOCUMENT_NODE||node.nodeType==$_.Node.DOCUMENT_FRAGMENT_NODE);},getFirstVisibleChild:function(node,includeNode){if(!node){return null;}
if((node.nodeType==$_.Node.TEXT_NODE&&this.isEmpty(node))||(node.nodeType==$_.Node.ELEMENT_NODE&&node.offsetHeight==0&&jQuery.inArray(node.nodeName.toLowerCase(),this.nonEmptyTags)===-1)){return null;}
if(node.nodeType==$_.Node.TEXT_NODE||(node.nodeType==$_.Node.ELEMENT_NODE&&node.childNodes.length==0)||!jQuery(node).contentEditable()){return includeNode?node:null;}
var i;for(i=0;i<node.childNodes.length;++i){var visibleChild=this.getFirstVisibleChild(node.childNodes[i],true);if(visibleChild!=null){return visibleChild;}}
return null;},getLastVisibleChild:function(node,includeNode){if(!node){return null;}
if((node.nodeType==$_.Node.TEXT_NODE&&this.isEmpty(node))||(node.nodeType==$_.Node.ELEMENT_NODE&&node.offsetHeight==0&&jQuery.inArray(node.nodeName.toLowerCase(),this.nonEmptyTags)===-1)){return null;}
if(node.nodeType==$_.Node.TEXT_NODE||(node.nodeType==$_.Node.ELEMENT_NODE&&node.childNodes.length==0)||!jQuery(node).contentEditable()){return includeNode?node:null;}
var i;for(i=node.childNodes.length-1;i>=0;--i){var visibleChild=this.getLastVisibleChild(node.childNodes[i],true);if(visibleChild!=null){return visibleChild;}}
return null;}});GENTICS.Utils.Dom=new Dom();return GENTICS.Utils.Dom;});